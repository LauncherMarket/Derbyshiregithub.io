import customtkinter as ctk
import requests
from datetime import datetime
import threading
import time

# --- SYSTEM THEME ---
ctk.set_appearance_mode("Dark")
ctk.set_default_color_theme("blue")

class ApexUnifiedHub(ctk.CTk):
    def __init__(self):
        super().__init__()

        # --- HUB CONFIGURATION ---
        self.title("STATION #768 | UNIFIED INTELLIGENCE")
        self.geometry("800x1000")
        self.PIN = "0083"

        # --- UPLINK KEYS ---
        self.WEBHOOK = "https://discord.com/api/webhooks/1475098952779956265/XmjswNOWI1xFlybXl7mSgAgHQvMyJr8UALejPWdx7mLSJL8IsUfNDI1cflub9wmBgowG"
        self.ROLE = "<@&14749276126260027505>"
        self.PUSH_USER = "uswuuq7126iw6if6stqx66ytjzi171"
        self.PUSH_TOKEN = "aa9a5wi8ag5pn2uxcg5f6c3acqsg3w"
        
        self.setup_auth()

    def setup_auth(self):
        self.auth_frame = ctk.CTkFrame(self, corner_radius=20, border_width=2, border_color="#ff4d00")
        self.auth_frame.place(relx=0.5, rely=0.5, anchor="center")
        ctk.CTkLabel(self.auth_frame, text="APEX COMMAND #768", font=("Orbitron", 26, "bold"), text_color="#ff4d00").pack(pady=20, padx=40)
        self.pin_entry = ctk.CTkEntry(self.auth_frame, placeholder_text="STATION PIN", show="*", width=150, font=("Arial", 24), justify="center")
        self.pin_entry.pack(pady=30)
        ctk.CTkButton(self.auth_frame, text="AUTHORIZE", fg_color="#ff4d00", text_color="black", command=self.authorize).pack(pady=20)

    def authorize(self):
        if self.pin_entry.get() == self.PIN:
            self.auth_frame.destroy()
            self.setup_main_interface()
        else:
            self.log("AUTH ERROR: ACCESS DENIED.")

    def setup_main_interface(self):
        self.header = ctk.CTkLabel(self, text="STATION #768 | MASTER CONTROL", font=("Orbitron", 22, "bold"))
        self.header.pack(pady=20)

        # Unified Terminal
        self.terminal = ctk.CTkTextbox(self, height=450, corner_radius=15, border_width=2, border_color="#333", font=("Consolas", 12), text_color="#00ff9d")
        self.terminal.pack(padx=30, pady=10, fill="x")
        self.log("SYSTEM ARMED. ANDROID EMERGENCY FORCE ACTIVE.")

        # Controls
        self.btn_grid = ctk.CTkFrame(self, fg_color="transparent")
        self.btn_grid.pack(pady=10)
        self.add_btn("ðŸ“¡ SYNC NWS (FL+DC)", "#3498db", self.sync_all_nws, 0, 0)
        self.add_btn("âœ… STATUS: SAFE", "#2ecc71", lambda: self.dispatch_force("STATUS", "Yan is SAFE", p=0), 0, 1)
        self.add_btn("ðŸš¨ TRIGGER PANIC", "#e74c3c", self.panic_sequence, 1, 0)

    def add_btn(self, text, color, cmd, r, c):
        ctk.CTkButton(self.btn_grid, text=text, fg_color=color, font=("Roboto", 12, "bold"), width=240, height=60, command=cmd).grid(row=r, column=c, padx=10, pady=10)

    def log(self, msg):
        self.terminal.insert("1.0", f"[{datetime.now().strftime('%H:%M:%S')}] {msg}\n")

    # --- UNIFIED SYNC LOGIC ---
    def sync_all_nws(self):
        """Pulls from both Florida and Washington OPC Zones"""
        self.log("POLLING GLOBAL NWS API SECTORS...")
        
        try:
            # Sector 1: Florida Land (Active Alerts)
            fl_data = requests.get("https://api.weather.gov/alerts/active?area=FL").json().get('features', [])
            # Sector 2: Washington OPC Marine (Zone ANZ925)
            dc_data = requests.get("https://api.weather.gov/alerts/active?zone=ANZ925").json().get('features', [])
            
            combined = fl_data + dc_data
            if not combined:
                self.log("SCAN COMPLETE: NO ACTIVE THREATS.")
                return

            for alert in combined[:3]:
                props = alert['properties']
                event = props.get('event')
                headline = props.get('headline')
                severity = props.get('severity', 'Moderate')
                
                self.log(f"ALERT DETECTED: {event} ({severity})")
                
                # Priority Logic
                p_level = 2 if (severity in ['Extreme', 'Severe'] or "Hurricane" in event) else 1
                self.dispatch_force(event, headline, p=p_level)

        except Exception as e:
            self.log(f"API ERROR: {str(e)}")

    def dispatch_force(self, title, message, p=1):
        """Unified Dispatch to Discord and Android Emergency Override"""
        # 1. Discord Dispatch
        payload = {
            "content": f"ðŸ“¡ **STATION 768 UNIFIED UPLINK** {self.ROLE}",
            "embeds": [{"title": title, "description": message, "color": 16729856 if p > 1 else 3447003}]
        }
        requests.post(self.WEBHOOK, json=payload)

        # 2. Android Force Dispatch (Pushover)
        push_data = {
            "token": self.PUSH_TOKEN,
            "user": self.PUSH_USER,
            "message": f"<b>{title}</b>\n{message}",
            "html": 1,
            "priority": p,
            "sound": "emergency" if p == 2 else "climb",
            "url": "https://www.weather.gov/mfl/",
            "url_title": "VIEW SECTOR DATA"
        }
        if p == 2: # Required for Emergency Overrides
            push_data.update({"retry": 30, "expire": 3600})
            
        requests.post("https://api.pushover.net/1/messages.json", data=push_data)
        self.log(f"UPLINK DISPATCHED: {title}")

    def panic_sequence(self):
        self.log("CRITICAL: PANIC TRIGGERED.")
        self.dispatch_force("CIVIL EMERGENCY", "STATION 768 PANIC TRIGGERED. PERSONNEL IN DANGER.", p=2)

if __name__ == "__main__":
    app = ApexUnifiedHub()
    app.mainloop()
